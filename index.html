      el.style.left = px(rect.left - stageRect.left);
      el.style.top  = px(rect.top  - stageRect.top);

      // Remove it from the normal document flow after absolute positioning
      // (so it stays where you dropped it)
    }

    function releaseDrag(){
      if(!active) return;

      try { active.releasePointerCapture && active.releasePointerCapture(active.__pid); } catch(e){}
      active.classList.remove('dragging');
      active.__pid = null;
      active = null;
    }

    function onDown(e){
      const el = e.target.closest('.draggable');
      if(!el) return;

      // If it hasn't been made absolute yet, do it now
      if(getComputedStyle(el).position !== 'absolute'){
        // First, we must move everything into a shared absolute coordinate system.
        // We'll absolute-position the whole card's children once (clean).
        const children = Array.from(document.getElementById('card').children);
        children.forEach(child => ensureAbsolute(child));

        // Then kill the card layout so it doesn't "snap back"
        const card = document.getElementById('card');
        card.style.position = 'absolute';
        card.style.left = '0';
        card.style.top = '0';
        card.style.width = '100%';
        card.style.height = '100%';
        card.style.transform = 'none';
      }

      active = el;
      active.classList.add('dragging');

      const r = active.getBoundingClientRect();
      const sr = stage.getBoundingClientRect();

      // pointer start
      startX = e.clientX;
      startY = e.clientY;

      originLeft = r.left - sr.left;
      originTop  = r.top  - sr.top;

      // capture pointer (mobile + desktop)
      active.__pid = e.pointerId;
      try { active.setPointerCapture(e.pointerId); } catch(err){}

      e.preventDefault();
    }

    function onMove(e){
      if(!active) return;

      const dx = e.clientX - startX;
      const dy = e.clientY - startY;

      active.style.left = px(originLeft + dx);
      active.style.top  = px(originTop + dy);

      e.preventDefault();
    }

    function onUp(){
      releaseDrag();
    }

    // Stage listeners
    stage.addEventListener('pointerdown', onDown);
    stage.addEventListener('pointermove', onMove);
    stage.addEventListener('pointerup', onUp);
    stage.addEventListener('pointercancel', onUp);

    // If pointer capture is lost, release
    stage.addEventListener('lostpointercapture', () => releaseDrag());

    // Click/tap outside to release
    document.addEventListener('pointerdown', (e) => {
      if(active && !e.target.closest('.draggable')){
        releaseDrag();
      }
    }, true);

    // ESC = force release
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape') releaseDrag();
    });

    // If the browser loses focus or tab changes, release
    window.addEventListener('blur', releaseDrag);
    document.addEventListener('visibilitychange', () => {
      if(document.hidden) releaseDrag();
    });
  </script>
</body>
</html>
